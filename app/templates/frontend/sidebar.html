<!-- Sidebar -->
<aside id="sidebar" class="fixed top-16 left-0 w-64 h-[calc(100vh-4rem)] bg-gray-100 dark:bg-gray-900 p-4 shadow-inner transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out overflow-y-auto z-40" style="scrollbar-width: thin;">
    <h2 class="text-2xl font-extrabold mb-6 text-gray-800 dark:text-gray-100 tracking-wide">Python Tutorial</h2>
    
    <!-- Dynamic Topic List -->
    <ul id="sidebar-topic-list" class="space-y-4 pl-4 text-gray-700 dark:text-gray-300">
        <li class="text-sm text-gray-500">Loading topics...</li>
    </ul>
</aside>

<!-- Overlay for mobile/tablet -->
<div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-30 z-30 lg:hidden" onclick="toggleSidebar()"></div>

<!-- Sidebar Logic -->
<script>
  // Sidebar open/close
  function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebar-overlay");
    const isOpen = !sidebar.classList.contains("-translate-x-full");

    if (isOpen) {
      sidebar.classList.add("-translate-x-full");
      overlay.classList.add("hidden");
    } else {
      sidebar.classList.remove("-translate-x-full");
      overlay.classList.remove("hidden");
    }
  }

  function closeSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebar-overlay");
    sidebar.classList.add("-translate-x-full");
    overlay.classList.add("hidden");
  }

  // Expand/collapse subtopics
  function toggleSubtopics(id, arrowId) {
    const subMenu = document.getElementById(id);
    const arrow = document.getElementById(arrowId);

    if (subMenu.style.maxHeight && subMenu.style.maxHeight !== "0px") {
      subMenu.style.maxHeight = "0px";
      arrow.style.transform = "rotate(0deg)";
    } else {
      subMenu.style.maxHeight = subMenu.scrollHeight + "px";
      arrow.style.transform = "rotate(90deg)";
    }
  }

  
  async function loadTopics() {
      try {
        const response = await fetch("/api/v1/topics/sidebar");
        const topics = await response.json();
    
        const sidebar = document.getElementById("sidebar-topic-list");
        sidebar.innerHTML = ""; // Clear loading placeholder
    
        topics.forEach(topic => {
          // Check for same-title single subtopic
          const onlyOneSameSub =
            topic.subtopics &&
            topic.subtopics.length === 1 &&
            topic.subtopics[0].title.trim().toLowerCase() === topic.title.trim().toLowerCase();
    
          if (onlyOneSameSub) {

            const sub = topic.subtopics[0];
            //console.log(topic.subtopics)
            const html = `
              <li>
                <a href="/python/${sub.slug}" class="block font-semibold hover:text-green-600 hover:underline" onclick="closeSidebar()">${sub.title}</a>
              </li>
            `;
            sidebar.innerHTML += html;
    
          } else if (topic.subtopics && topic.subtopics.length > 0) {
            //console.log(topic.subtopics)
            const topicId = `sub-${topic.id}`;
            const arrowId = `arrow-${topic.id}`;
            const html = `
              <li>
                <button onclick="toggleSubtopics('${topicId}', '${arrowId}')" class="w-full text-left font-semibold hover:text-green-600 flex justify-between items-center focus:outline-none">
                  ${topic.title}
                  <span id="${arrowId}" class="inline-block transition-transform duration-300 text-green-600">&#9656;</span>
                </button>
                <ul id="${topicId}" class="pl-5 mt-2 space-y-2 max-h-0 overflow-hidden transition-all duration-300 ease-in-out text-sm">
                  ${topic.subtopics.map(sub =>
                    `<li>
                     <a href="/python/${sub.slug}" 
                      class="block hover:text-green-600 hover:underline" 
                      onclick="closeSidebar()">
                      ${sub.title}
                    </a>
                    </li>`).join("")}
                </ul>
              </li>
            `;
            sidebar.innerHTML += html;
    
          } else {
            // No subtopics
            const html = `
              <li>
                <a href="/python/${topic.slug}" class="block font-semibold hover:text-green-600 hover:underline" onclick="closeSidebar()">${topic.title}</a>
              </li>
            `;
            sidebar.innerHTML += html;
          }
        });
      } catch (error) {
        console.error("Failed to load topics:", error);
        document.getElementById("sidebar-topic-list").innerHTML =
          `<li class="text-sm text-red-500">Failed to load topics.</li>`;
      }
    }
  
    // Load on DOM ready
    document.addEventListener("DOMContentLoaded", loadTopics);
  
</script>
